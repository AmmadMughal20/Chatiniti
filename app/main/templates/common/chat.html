{% extends 'base.html' %}

{% block main %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    crossorigin="anonymous">

<!-- Add audio elements for call handling -->
<audio id="localAudio" autoplay muted></audio>
<audio id="remoteAudio" autoplay></audio>

<!-- Add call notification modal -->
<div id="callModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Incoming Call</h3>
        <p id="callerName"></p>
        <button id="acceptCall">Accept</button>
        <button id="rejectCall">Reject</button>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get all contact list items
        var contactItems = document.querySelectorAll('.item');

        // Add click event listener to each contact list item
        contactItems.forEach(function (item) {
            item.addEventListener('click', function () {
                // Get the ID of the selected contact
                var contactId = item.dataset.contactId;

                // Redirect to the chat route with the selected contact ID
                window.location.href = '/chat/' + contactId;
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        var chatMessages = document.getElementById("chat-messages");
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    document.addEventListener('DOMContentLoaded', function () {
        let localStream = null;
        let peerConnection = null;
        let isInCall = false;
        var userid = "{{ session['user_id'] }}";
        var conversationId = "{{ conversation_id }}";

        // WebRTC configuration
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Handle phone icon click
        let callBtn = document.getElementById('call-btn');
        if (callBtn) {
            callBtn.addEventListener('click', function () {
                console.log('call btn clicked')
                if (!isInCall) {
                    startCall();
                } else {
                    endCall();
                }
            });
        }

        async function startCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log(localStream, 'printing localStream')
                document.getElementById('localAudio').srcObject = localStream;

                peerConnection = new RTCPeerConnection(configuration);

                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Create and send offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                socket.emit('call_user', {
                    conversation_id: conversationId,
                    offer: offer,
                    caller_id: userid
                });

                setupPeerConnectionHandlers();
                isInCall = true;
                document.getElementById('call-btn').style.color = 'green';
            } catch (error) {
                console.error('Error starting call:', error);
                alert('Could not start call. Please check your microphone permissions.');
            }
        }

        function setupPeerConnectionHandlers() {
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice_candidate', {
                        conversation_id: conversationId,
                        candidate: event.candidate
                    });
                }
            };
        }

        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            isInCall = false;
            document.getElementById('call-btn').style.color = '';
            document.getElementById('localAudio').srcObject = null;
            document.getElementById('remoteAudio').srcObject = null;

            socket.emit('end_call', {
                conversation_id: conversationId
            });
        }

        // Handle incoming call
        socket.on('receive_call', async function (data) {
            if (data.caller_id !== userid) {
                document.getElementById('callModal').style.display = 'block';
                document.getElementById('callerName').textContent = 'Incoming call...';

                document.getElementById('acceptCall').onclick = async function () {
                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        document.getElementById('localAudio').srcObject = localStream;

                        peerConnection = new RTCPeerConnection(configuration);

                        localStream.getTracks().forEach(track => {
                            peerConnection.addTrack(track, localStream);
                        });

                        setupPeerConnectionHandlers();

                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        socket.emit('answer_call', {
                            conversation_id: conversationId,
                            answer: answer
                        });

                        document.getElementById('callModal').style.display = 'none';
                        isInCall = true;
                        document.getElementById('call-btn').style.color = 'green';
                    } catch (error) {
                        console.error('Error accepting call:', error);
                        alert('Could not accept call. Please check your microphone permissions.');
                    }
                };

                document.getElementById('rejectCall').onclick = function () {
                    document.getElementById('callModal').style.display = 'none';
                    socket.emit('reject_call', {
                        conversation_id: conversationId
                    });
                };
            }
        });

        // // Handle call answer
        socket.on('call_answered', async function (data) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        });

        // // Handle ICE candidates
        socket.on('ice_candidate', async function (data) {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                }
            }
        });

        // // Handle call end
        socket.on('call_ended', function () {
            endCall();
        });
    });

    document.addEventListener('DOMContentLoaded', function () {

        socket.on('contact_statuses', function (statuses) {
            for (var userId in statuses) {
                var statusElement = document.querySelector(`.item[data-contact-id="${userId}"] .status`);
                if (statusElement) {
                    statusElement.innerText = statuses[userId].status === 'online' ? 'Online' : 'Offline';
                    statusElement.style.color = statuses[userId].status === 'online' ? 'green' : 'red';
                }

                var statusElementTop = document.querySelector(`[data-contact-id-top="${userId}"] .top-status`);
                if (statusElementTop) {
                    statusElementTop.innerText = statuses[userId].status === 'online' ? 'Online' : 'Offline';
                    statusElementTop.style.color = statuses[userId].status === 'online' ? 'green' : 'red';
                }
            }

            socket.on('user-offline', function (data) {
                var statusElementTop = document.querySelector(`[data-contact-id-top="${data.user_id}"] .top-status`);
                if (statusElementTop) {
                    statusElementTop.innerText = 'Offline';
                    statusElementTop.style.color = 'red';
                }
            });


        });

        // Request statuses of all contacts
        function getContactStatuses() {
            var contactIds = Array.from(document.querySelectorAll('.item')).map(item => item.dataset.contactId);
            console.log(contactIds, 'printing contact ids')
            socket.emit('get_contact_statuses', { contact_ids: contactIds });
        }

        // Call getContactStatuses on page load
        getContactStatuses();

        socket.on('status_response', function (data) {
            var statusDiv = document.getElementById('user-status');
            statusDiv.innerHTML = `${data.user_id} is ${data.status}`;
        });

        var userid = "{{ session['user_id'] }}";
        var conversationId = "{{ conversation_id }}";

        // Ensure the client joins the conversation room
        function joinConversation(conversationId) {
            if (conversationId) {
                socket.emit('join_conversation', {
                    userid: userid,
                    conversation_id: conversationId
                });
            }
        }

        joinConversation(conversationId);

        function sendMessage() {
            var messageInput = document.getElementById('message-input');
            var message = messageInput.value;
            if (message.trim()) {
                var createdAt = new Date();
                socket.emit('send_message', {
                    message: message,
                    sender: userid,
                    conversation_id: conversationId,
                    sender_id: userid,
                    createdAt: createdAt
                });
                messageInput.value = '';
                appendMessage({
                    message: message,
                    sender: userid,
                    createdAt: formatDate(createdAt)
                }, true);
            }
        }

        document.getElementById('send-btn').onclick = sendMessage;

        let typing = false;
        let typingTimeout;

        document.getElementById('message-input').addEventListener('keydown', function (event) {
            if (!typing) {
                typing = true;
                socket.emit('started_typing', { user_id: userid });
            }

            clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                typing = false;
                socket.emit('stopped_typing', { user_id: userid });
            }, 1000);

            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        socket.on('user_typing_status', function (data) {
            if (data.user_id !== userid) {  // Do not show "Typing..." for yourself
                const typingElement = document.querySelector('.typing-status');
                if (data.typing_status) {
                    typingElement.style.display = 'block';
                } else {
                    typingElement.style.display = 'none';
                }
            }
        });

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            let hours = d.getHours();
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            hours = String(hours).padStart(2, '0'); // pad with leading zeros if necessary
            return `${hours}:${minutes} ${ampm}`;
        }

        function appendMessage(data, isSender) {
            var messagesDiv = document.getElementById('chat-messages');
            var newMessage = document.createElement('div');
            newMessage.classList.add('main-container', 'clearfix');
            newMessage.innerHTML = '<div class="message-container ' + (isSender ? 'sent' : 'received') + '"><div><span class="message">' + data.message + '</span></div><div class="time-div"><span class="timestamp">' + data.createdAt + '</span></div></div>';
            messagesDiv.appendChild(newMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        socket.on('receive_message', function (data) {
            console.log(' in receive message socket')
            if (data.sender !== userid)
                appendMessage({
                    message: data.message,
                    sender: data.sender,
                    createdAt: formatDate(data.createdAt)
                }, false);
        });

        document.querySelectorAll('.timestamp').forEach(function (element) {
            var date = new Date(element.innerText);
            element.innerText = formatDate(date);
        });

        document.getElementById('contact_search').addEventListener('input', printingSearch);

        function printingSearch() {
            var searchBar = document.getElementById('contact_search').value.toLowerCase();
            var contactItems = document.querySelectorAll('.item');
            contactItems.forEach(function (item) {
                var contactName = item.querySelector('.name').innerText.toLowerCase();
                if (contactName.includes(searchBar)) {
                    item.style.display = 'flex'; // Show the contact item if it matches the search
                } else {
                    item.style.display = 'none'; // Hide the contact item if it doesn't match the search
                }
            });
        }

        // Handle contact item click
        document.querySelectorAll('.item').forEach(function (item) {
            item.addEventListener('click', function () {
                var contactId = item.dataset.contactId;
                loadChat(contactId);
            });
        });

        function loadChat(contactId) {
            fetch(`/chat/${contactId}`)
                .then(response => response.json())
                .then(data => {
                    // Update chat header
                    var chatHeader = document.querySelector('.chat-header');
                    chatHeader.querySelector('h3').innerText = data.contactName;
                    chatHeader.querySelector('.last-sceen').innerText = `Last seen: ${data.lastLogin}`;

                    // Update chat messages
                    var chatMessages = document.querySelector('.chat-messages');
                    chatMessages.innerHTML = '';
                    data.chat_history.forEach(chat => {
                        appendMessage(chat, chat.sender === 'You');
                    });

                    // Update conversation ID
                    conversationId = data.conversation_id;
                    joinConversation(conversationId);
                });
        }
    });
</script>

<!-- start of call modal -->
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 5px;
        width: 300px;
        text-align: center;
    }

    #acceptCall,
    #rejectCall {
        margin: 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #acceptCall {
        background-color: #4CAF50;
        color: white;
    }

    #rejectCall {
        background-color: #f44336;
        color: white;
    }

    #call-btn {
        cursor: pointer;
    }
</style>
<!-- end of call modal -->

<!-- start of chat container -->
{% if 'user_id' in session %}
<div class="chat-container">
    <div class="contacts">
        <div style="border-bottom: 1px solid grey; position: relative;">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="contact_search" placeholder="Search" />
        </div>
        <ul>
            {% for contact in contacts %}
            <li data-contact-id="{{ contact['user_id'] }}" class="item">
                <img src="{{ contact.image }}" alt="{{ contact.name }}" class="contact-image">
                <span class="name">{{ contact.name }}</span>
                <span class="status">Offline</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="chat">
        <div class="chat-header" id="chat-header">
            <div>
                {% if contactName %}
                <h3>{{ contactName }}</h3>
                {% if lastLogin %}
                <p class="last-sceen">Last seen: {{ lastLogin }}</p>
                {% else %}
                <div data-contact-id-top="{{ contactId }}">
                    <span class="top-status">Offline</span>
                </div>
                {% endif %}
                <p class="typing-status" style="display: none;">Typing...</p>
                {% endif %}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
                <button id="call-btn">
                    <p class="fas fa-phone-volume"></p>
                </button>
                <p class="fa-solid fa-video" id="video-btn"></p>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            {% if chat_history %}
            {% for chat in chat_history %}
            {% if chat.sender == "You" %}
            <div class="main-container">
                <div class="message-container sent">
                    <div>
                        <span class="message">{{ chat.message }}</span>
                    </div>
                    <div class="time-div">
                        <span class="timestamp">{{ chat.createdAt }}</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="main-container">
                <div class="message-container received">
                    <div>
                        <span class="message">{{ chat.message }}</span>
                    </div>
                    <div class="time-div">
                        <span class="timestamp">{{ chat.createdAt }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            {% if contactName %}
            {%else%}
            <h3>Start a conversation to view</h3>
            {% endif %}
            {% endif %}
        </div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type a message...">
            <div class="message-buttons">
                <button id="send-btn">Send</button>
                <button id="attach-btn">Attach</button>
            </div>
        </div>
    </div>
    <div id="user-status"></div>
</div>
<!-- end of chat container -->

<!-- start of video call container -->
<!-- <div class="chat-container">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <button id="callButton">Call</button>
    <button id="answerButton" style="display:none;">Answer</button>
    </div> -->
<!-- end of video call container -->

<!-- start of login to view chats -->
{% else %}
<div>
    Login to view chats
</div>
<!-- end of login to view chats -->
{%endif%}

{% endblock %}

{% block hide_footer %}
{% set hide_footer = true %}
{% endblock %}